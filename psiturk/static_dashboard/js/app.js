// Generated by CoffeeScript 1.6.1
(function(){define(["jquery","underscore","backbone","router","models/ConfigModel","models/AtAGlanceModel","views/SidebarView","views/ContentView","views/HITView","models/HITModel","collections/HITCollection","text!templates/overview.html","text!templates/sidebar.html","views/RunExptView"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return{events:{"click a":"pushstateClick","click li":"pushstateClick"},pushstateClick:function(e){return e.preventDefault()},getCredentials:function(){var t=this;e("#aws-info-modal").modal("show");return e(".save").click(function(n){n.preventDefault();t.save(n);return e("#aws-info-modal").modal("hide")})},save:function(n){var r,i,s,o=this;n.preventDefault();s=e(n.target).data("section");i={};r={};e.each(e("#myform").serializeArray(),function(e,t){return i[t.name]=t.value});r[s]=i;this.config.save(r);e("li").removeClass("selected");e("#overview").addClass("selected");return e.when(this.config.fetch(),this.ataglance.fetch().then(function(){var n,r,i;r=t.template(c,{input:{balance:o.ataglance.get("balance"),debug:o.config.get("Server Parameters").debug==="True"?"checked":"",using_sandbox:o.config.get("HIT Configuration").using_sandbox==="True"?"checked":""}});e("#content").html(r);n=new a({collection:new l});e("#tables").html(n.render().el);i=t.bind(o.saveUsingSandboxState,o);e("input#using_sandbox").on("click",function(){return i()});e("input#debug").on("click",function(){return o.saveDebugState()});e("li").removeClass("selected");e("#overview").addClass("selected");return o.pubsub.trigger("captureUIEvents")}))},pushstateClick:function(e){return e.preventDefault()},verifyAWSLogin:function(){var t,n=this;t=this.config.fetch();return t.done(function(){var t,r,i;r=n.config.get("AWS Access").aws_access_key_id;i=n.config.get("AWS Access").aws_secret_access_key;t={};t.aws_access_key_id=r;t.aws_secret_access_key=i;return e.ajax({url:"/verify_aws_login",type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(t),success:function(t){if(t.aws_accnt===0){n.getCredentials();return e("#aws-indicator").css("color","red").attr("class","icon-lock")}return e("#aws-indicator").css("color","white").attr("class","icon-unlock")},error:function(){return console.log("aws verification failed")}})})},serverParamsSave:function(){var t;this.save();t=this.config.fetch();return t.done(function(){var t,n,r;n=this.config.get("HIT Configuration").question_url+"/shutdown";r=/^https?\:\/\/([^\/:?#]+)(?:[\/:?#]|$)/i;t=n.match(r)[0]+this.config.get("Server Parameters").port+"/shutdown";return e.ajax({url:t,type:"GET",data:{hash:this.config.get("Server Parameters").hash}})})},saveDebugState:function(){var t;t=e("input#debug").is(":checked");return this.config.save({"Server Parameters":{debug:t}})},saveUsingSandboxState:function(){var t,n=this;t=e("input#using_sandbox").is(":checked");return this.config.save({"HIT Configuration":{using_sandbox:t}},{complete:function(){return e.when(n.config.fetch(),n.ataglance.fetch().done(function(){return n.loadOverview()}))}},{error:function(e){return console.log("error")}})},getExperimentStatus:function(){return e.ajax({url:"/get_hits",type:"GET",success:function(t){return t.hits.length>0?e("#experiment_status").css({color:"green"}):e("#experiment_status").css({color:"grey"})}})},launchPsiTurkServer:function(){return e.ajax({url:"/launch",type:"GET"})},stopPsiTurkServer:function(){e("#server-off-modal").modal("show");return e("#shutdownServerBtn").on("click",function(){return e.ajax({url:"/shutdown_psiturk",type:"GET",success:e("#server-off-modal").modal("hide")})})},loadHITTable:function(){var t;t=new a({collection:new l});return e("#tables").html(t.render().el)},monitorPsiturkServer:function(){var t;t=0;e.ajax({url:"/monitor_server"});return e.doTimeout("server_poll",1e3,function(){e.ajax({url:"/server_status",success:function(n){var r;r=parseInt(n.state);if(r===t){e("#server_status").css({color:"green"});e("#server_on").css({color:"grey"});return e("#server_off").css({color:"orange"})}e("#server_status").css({color:"red"});e("#server_off").css({color:"grey"});return e("#server_on").css({color:"orange"})}});return!0})},loadAWSData:function(){var n,r,a=this;this.ataglance=new s;n=this.ataglance.fetch();n.done(function(){var n;a.config=new i;n=a.config.fetch();return n.done(function(){var n,r,i;n=t.template(c,{input:{balance:a.ataglance.get("balance"),debug:a.config.get("Server Parameters").debug==="True"?"checked":"",using_sandbox:a.config.get("HIT Configuration").using_sandbox==="True"?"checked":""}});e("#content").html(n);r=t.template(h);e("#sidebar").html(r);i=new o({config:a.config,ataglance:a.ataglance,pubsub:a.pubsub});a.loadHITTable();a.captureUIEvents();return a.verifyAWSLogin()})});r=new u;return r.initialize()},loadOverview:function(){var n,r,o,u,f,h=this;r=new i;n=new s;o=function(){return h.pubsub.trigger("captureUIEvents")};f=t.bind(this.saveUsingSandboxState,this);u=t.bind(this.saveDebugState,this);return e.when(r.fetch(),n.fetch().then(function(){var i,s;s=t.template(c,{input:{balance:n.get("balance"),debug:r.get("Server Parameters").debug==="True"?"checked":"",using_sandbox:r.get("HIT Configuration").using_sandbox==="True"?"checked":""}});e("#content").html(s);i=new a({collection:new l});e("#tables").html(i.render().el);return o()}))},captureUIEvents:function(){var n,r,i,s,o=this;e("#server_off").off("click").on("click",function(){return o.stopPsiTurkServer()});e("#server_on").off("click").on("click",function(){return o.launchPsiTurkServer()});e(".restart").off("click").on("click",function(e){o.save(e);o.stopPsiTurkServer();return o.launchPsiTurkServer()});e("#run").off("click").on("click",function(){var t;t=new p({config:o.config});e("#run-expt-modal").modal("show");e(".run-expt").on("keyup",function(t){var n,r,i;i={};r={};e.each(e("#expt-form").serializeArray(),function(e,t){return i[t.name]=t.value});n=.1;e("#total").html((i.reward*i.max_assignments*(1+n)).toFixed(2));e("#fee").val((i.reward*i.max_assignments*n).toFixed(2));r["HIT Configuration"]=i;return o.config.save(r)});return e("#run-expt-btn").on("click",function(){return e.ajax({contentType:"application/json; charset=utf-8",url:"/mturk_services",type:"POST",dataType:"json",data:JSON.stringify({mturk_request:"create_hit"}),complete:function(){var t;e("#run-expt-modal").modal("hide");t=new a({collection:new l});e("#tables").html(t.render().el);return o.pubsub.trigger("getExperimentStatus")},error:function(t){console.log(t);return e("#expire-modal").modal("hide")}})})});e("#shutdown-dashboard").off("click").on("click",function(){return e.ajax({url:"/shutdown",type:"GET",complete:function(){return window.location.replace("http://nyuccl.github.io/psiTurk/")}})});i=t.bind(this.saveUsingSandboxState,this);r=t.bind(this.save,this);e(document).off("click").on("click",".save",function(){event.preventDefault();o.options.pubsub.trigger("save",event);return e(document).off("click").on("click",".save_data",function(e){e.preventDefault();return o.options.pubsub.trigger("save",e)})});e("input#using_sandbox").on("click",function(){return i()});e("input#debug").on("click",function(){return o.saveDebugState()});e(document).off("click").on("click","#aws-info-save",function(){return o.verifyAWSLogin()});e(document).on("click","#server-parms-save",function(){return o.serverParamsSave()});s=this.pubsub.trigger("getExperimentStatus");n=this.loadOverview;e(document).on("click",".expire",function(){var t;t=e(this).attr("id");e("#expire-modal").modal("show");return e("#expire-btn").on("click",function(){var r,i=this;r=JSON.stringify({mturk_request:"expire_hit",hitid:t});return e.ajax({contentType:"application/json; charset=utf-8",url:"/mturk_services",type:"POST",dataType:"json",data:r,complete:function(){e("#expire-modal").modal("hide");return n()},error:function(e){return console.log("failed to expire HIT")}})})});return e(document).on("click",".extend",function(){var t;t=e(this).attr("id");e("#extend-modal").modal("show");return e("#extend-btn").on("click",function(){var r;r=JSON.stringify({mturk_request:"extend_hit",hitid:t,assignments_increment:e("#extend-workers").val(),expiration_increment:e("#extend-time").val()});return e.ajax({contentType:"application/json; charset=utf-8",url:"/mturk_services",type:"POST",dataType:"json",data:r,complete:function(){e("#extend-modal").modal("hide");return n()},error:function(e){return console.log("failed to extend HIT")}})})})},initialize:function(){r.initialize();this.pubsub=t.extend({},n.Events);t.bindAll(this,"getExperimentStatus");t.bindAll(this,"captureUIEvents");t.bindAll(this,"loadOverview");t.bindAll(this,"save");this.pubsub.bind("getExperimentStatus",this.getExperimentStatus);this.pubsub.bind("captureUIEvents",this.captureUIEvents);this.pubsub.bind("loadOverview",this.loadOverview);this.pubsub.bind("save",this.save);this.monitorPsiturkServer();this.loadAWSData();return this.getExperimentStatus()}}})}).call(this);